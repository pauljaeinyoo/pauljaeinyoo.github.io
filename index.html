<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow - Multi-Account Todo Lists</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Braze SDK -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }

        +function(a,p,P,b,y){
            a.braze={};a.brazeQueue=[];
            const s="BrazeSdkMetadata DeviceProperties Card Card.prototype.dismissCard Card.prototype.removeAllSubscriptions Card.prototype.removeSubscription Card.prototype.subscribeToClickedEvent Card.prototype.subscribeToDismissedEvent Card.fromContentCardsJson ImageOnly CaptionedImage ClassicCard ControlCard ContentCards ContentCards.prototype.getUnviewedCardCount Feed Feed.prototype.getUnreadCardCount ControlMessage InAppMessage InAppMessage.SlideFrom InAppMessage.ClickAction InAppMessage.DismissType InAppMessage.OpenTarget InAppMessage.ImageStyle InAppMessage.Orientation InAppMessage.TextAlignment InAppMessage.CropType InAppMessage.prototype.closeMessage InAppMessage.prototype.removeAllSubscriptions InAppMessage.prototype.removeSubscription InAppMessage.prototype.subscribeToClickedEvent InAppMessage.prototype.subscribeToDismissedEvent InAppMessage.fromJson FullScreenMessage ModalMessage HtmlMessage SlideUpMessage User User.Genders User.NotificationSubscriptionTypes User.prototype.addAlias User.prototype.addToCustomAttributeArray User.prototype.addToSubscriptionGroup User.prototype.getUserId User.prototype.incrementCustomUserAttribute User.prototype.removeFromCustomAttributeArray User.prototype.removeFromSubscriptionGroup User.prototype.setCountry User.prototype.setCustomLocationAttribute User.prototype.setCustomUserAttribute User.prototype.setDateOfBirth User.prototype.setEmail User.prototype.setEmailNotificationSubscriptionType User.prototype.setFirstName User.prototype.setGender User.prototype.setHomeCity User.prototype.setLanguage User.prototype.setLastKnownLocation User.prototype.setLastName User.prototype.setPhoneNumber User.prototype.setPushNotificationSubscriptionType InAppMessageButton InAppMessageButton.prototype.removeAllSubscriptions InAppMessageButton.prototype.removeSubscription InAppMessageButton.prototype.subscribeToClickedEvent FeatureFlag FeatureFlag.prototype.getStringProperty FeatureFlag.prototype.getNumberProperty FeatureFlag.prototype.getBooleanProperty automaticallyShowInAppMessages destroyFeed hideContentCards showContentCards showFeed showInAppMessage deferInAppMessage toggleContentCards toggleFeed changeUser destroy getDeviceId initialize isPushBlocked isPushPermissionGranted isPushSupported logCardClick logCardDismissal logCardImpressions logContentCardImpressions logContentCardClick logCustomEvent logFeedDisplayed logInAppMessageButtonClick logInAppMessageClick logInAppMessageHtmlClick logInAppMessageImpression logPurchase openSession requestPushPermission removeAllSubscriptions removeSubscription requestContentCardsRefresh requestFeedRefresh refreshFeatureFlags requestImmediateDataFlush enableSDK isDisabled setLogger setSdkAuthenticationSignature addSdkMetadata disableSDK subscribeToContentCardsUpdates subscribeToFeedUpdates subscribeToInAppMessage subscribeToSdkAuthenticationFailures toggleLogging unregisterPush wipeData handleBrazeAction subscribeToFeatureFlagsUpdates getAllFeatureFlags logFeatureFlagImpression"
            .split(" ");
            for (var i = 0; i < s.length; i++) {
                var m = s[i], k = a.braze, l = m.split(".");
                for (var j = 0; j < l.length - 1; j++) k = k[l[j]];
                k[l[j]] = new Function("return function " + m.replace(/\./g, "_") +
                    "(){window.brazeQueue.push(arguments); return true}")();
            }
            y = p.createElement(P);
            y.type = 'text/javascript';
            y.src = 'https://js.appboycdn.com/web-sdk/5.1/braze.min.js';
            y.async = 1;
            b = p.getElementsByTagName(P)[0];
            b.parentNode.insertBefore(y, b);
        }(window, document, 'script');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .auth-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .auth-tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .app-section {
            display: none;
        }

        .app-section.active {
            display: block;
        }

        .user-info {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .user-welcome {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }

        .todo-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .todo-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .todo-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            text-align: center;
            min-width: 120px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .add-todo {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .add-todo input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            min-width: 250px;
        }

        .add-todo input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .todo-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .todo-list {
            space-y: 15px;
        }

        .todo-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .todo-item.completed {
            opacity: 0.7;
            border-left-color: #28a745;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: #6c757d;
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .todo-checkbox.checked {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .todo-text {
            flex: 1;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .todo-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #ffc107;
            color: white;
        }

        .edit-btn:hover {
            background: #ffb300;
            transform: scale(1.1);
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
        }

        .delete-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .priority-high { border-left-color: #ff6b6b !important; }
        .priority-medium { border-left-color: #ffc107 !important; }
        .priority-low { border-left-color: #28a745 !important; }

        .priority-selector {
            margin-left: 10px;
        }

        .priority-selector select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .auth-section, .todo-container {
                padding: 25px;
            }
            
            .add-todo {
                flex-direction: column;
            }
            
            .add-todo input {
                min-width: 100%;
            }
            
            .todo-filters {
                justify-content: center;
            }
            
            .user-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .todo-stats {
                justify-content: center;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

                 @keyframes slideIn {
             from { transform: translateX(-20px); opacity: 0; }
             to { transform: translateX(0); opacity: 1; }
         }

         /* Braze Content Cards Styles */
         .braze-feed {
             min-height: 200px;
         }

         .braze-controls {
             display: flex;
             gap: 10px;
             flex-wrap: wrap;
         }

         .braze-controls .filter-btn {
             background: #f8f9fa;
             border: 2px solid #e1e5e9;
             padding: 8px 15px;
             border-radius: 20px;
             cursor: pointer;
             transition: all 0.3s ease;
             font-weight: 500;
             font-size: 0.9rem;
         }

         .braze-controls .filter-btn:hover {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             border-color: #667eea;
             transform: translateY(-1px);
         }

         /* Braze card overrides */
         .ab-feed .ab-card {
             background: #f8f9fa !important;
             border-radius: 12px !important;
             margin-bottom: 15px !important;
             border-left: 4px solid #667eea !important;
             box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
             transition: all 0.3s ease !important;
         }

         .ab-feed .ab-card:hover {
             transform: translateY(-2px) !important;
             box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
         }

         .ab-feed .ab-card .ab-card-body {
             padding: 20px !important;
         }

         .ab-feed .ab-card .ab-card-title {
             color: #333 !important;
             font-weight: 600 !important;
             margin-bottom: 10px !important;
         }

         .ab-feed .ab-card .ab-card-text {
             color: #666 !important;
             line-height: 1.5 !important;
         }

         .ab-feed .ab-card .ab-pinned-indicator {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
             color: white !important;
             border-radius: 15px !important;
             padding: 4px 12px !important;
             font-size: 0.8rem !important;
         }
     </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tasks"></i> TaskFlow</h1>
            <p>Organize your life with beautiful, multi-account todo lists</p>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="auth-section">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
            </div>

            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>

            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="register-name">Full Name</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" required>
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </form>
        </div>

        <!-- App Section -->
        <div id="app-section" class="app-section">
            <div class="user-info">
                <div class="user-welcome">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div>
                        <h3 id="user-name">Welcome!</h3>
                        <p id="user-email">user@example.com</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <div class="todo-container">
                <div class="todo-header">
                    <h2><i class="fas fa-clipboard-list"></i> My Tasks</h2>
                    <div class="todo-stats">
                        <div class="stat-card">
                            <span class="stat-number" id="total-tasks">0</span>
                            <span class="stat-label">Total</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="completed-tasks">0</span>
                            <span class="stat-label">Completed</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="pending-tasks">0</span>
                            <span class="stat-label">Pending</span>
                        </div>
                    </div>
                </div>

                <div class="add-todo">
                    <input type="text" id="new-todo" placeholder="What needs to be done?" maxlength="200">
                    <div class="priority-selector">
                        <select id="todo-priority">
                            <option value="low">Low Priority</option>
                            <option value="medium" selected>Medium Priority</option>
                            <option value="high">High Priority</option>
                        </select>
                    </div>
                    <button class="add-btn" onclick="addTodo()">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </div>

                <div class="todo-filters">
                    <button class="filter-btn active" onclick="filterTodos('all')">All Tasks</button>
                    <button class="filter-btn" onclick="filterTodos('pending')">Pending</button>
                    <button class="filter-btn" onclick="filterTodos('completed')">Completed</button>
                    <button class="filter-btn" onclick="filterTodos('high')">High Priority</button>
                </div>

                                 <div id="todo-list" class="todo-list">
                     <div class="empty-state">
                         <i class="fas fa-clipboard-check"></i>
                         <h3>No tasks yet</h3>
                         <p>Add your first task above to get started!</p>
                     </div>
                 </div>
             </div>
             
             <!-- Braze Content Cards Section -->
             <div class="todo-container" style="margin-top: 30px;">
                 <div class="todo-header">
                     <h2><i class="fas fa-bell"></i> Notifications & Updates</h2>
                     <div class="braze-controls">
                         <button class="filter-btn" onclick="toggleBrazeCards()">
                             <i class="fas fa-sync-alt"></i> Refresh Cards
                         </button>
                         <button class="filter-btn" onclick="hideBrazeCards()">
                             <i class="fas fa-eye-slash"></i> Hide Cards
                         </button>
                         <button class="filter-btn" onclick="showBrazeCards()">
                             <i class="fas fa-eye"></i> Show Cards
                         </button>
                     </div>
                 </div>
                 <div id="braze-feed" class="braze-feed">
                     <div class="empty-state">
                         <i class="fas fa-satellite-dish"></i>
                         <h3>Loading notifications...</h3>
                         <p>Fetching your personalized content</p>
                     </div>
                 </div>
             </div>
         </div>
     </div>

    <script>
        // Application State
        let currentUser = null;
        let currentFilter = 'all';
        let editingTodo = null;

                 // Initialize the application
         document.addEventListener('DOMContentLoaded', function() {
             checkAuthState();
             setupEventListeners();
             initializeBraze();
         });

         function initializeBraze() {
             // Initialize Braze once the SDK is ready
             braze.initialize('7ad461d4-5c54-45a1-a0f2-c018596c87ca', {
                 baseUrl: "sondheim.braze.com",
                 enableLogging: true,
                 allowUserSuppliedJavascript: true
             });

             braze.toggleLogging();
             
             // Set initial user if logged in
             if (currentUser) {
                 braze.changeUser(currentUser.email);
                 updateBrazeUserProfile();
             } else {
                 braze.changeUser('anonymous_user');
             }
             
             braze.openSession(() => {
                 braze.requestContentCardsRefresh();
                 braze.showContentCards(document.getElementById("braze-feed"));
             });
         }

        function setupEventListeners() {
            // Auth form submissions
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            
            // Add todo on Enter key
            document.getElementById('new-todo').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTodo();
                }
            });
        }

        function checkAuthState() {
            const savedUser = localStorage.getItem('taskflow_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            } else {
                showAuth();
            }
        }

        function switchAuthTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchAuthTab('${tab}')"]`).classList.add('active');
            
            // Update forms
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            document.getElementById(`${tab}-form`).classList.add('active');
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // Get stored users
            const users = JSON.parse(localStorage.getItem('taskflow_users') || '{}');
            
                         if (users[email] && users[email].password === password) {
                 currentUser = users[email];
                 localStorage.setItem('taskflow_user', JSON.stringify(currentUser));
                 
                 // Update Braze user
                 braze.changeUser(currentUser.email);
                 updateBrazeUserProfile();
                 braze.logCustomEvent('User Login', { 
                     'login_method': 'email',
                     'user_name': currentUser.name 
                 });
                 
                 showApp();
                 showNotification('Welcome back!', 'success');
             } else {
                 showNotification('Invalid email or password', 'error');
                 braze.logCustomEvent('Login Failed', { 'email': email });
             }
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            // Get stored users
            const users = JSON.parse(localStorage.getItem('taskflow_users') || '{}');
            
            if (users[email]) {
                showNotification('Email already registered', 'error');
                return;
            }
            
            // Create new user
            const newUser = {
                name: name,
                email: email,
                password: password,
                todos: [],
                createdAt: new Date().toISOString()
            };
            
            users[email] = newUser;
            localStorage.setItem('taskflow_users', JSON.stringify(users));
            
                         currentUser = newUser;
             localStorage.setItem('taskflow_user', JSON.stringify(currentUser));
             
             // Update Braze user
             braze.changeUser(currentUser.email);
             updateBrazeUserProfile();
             braze.logCustomEvent('User Registration', { 
                 'registration_method': 'email',
                 'user_name': currentUser.name 
             });
             
             showApp();
             showNotification('Account created successfully!', 'success');
        }

                 function logout() {
             braze.logCustomEvent('User Logout', { 
                 'user_name': currentUser ? currentUser.name : 'unknown' 
             });
             
             localStorage.removeItem('taskflow_user');
             currentUser = null;
             braze.changeUser('anonymous_user');
             showAuth();
             showNotification('Logged out successfully', 'success');
         }

        function showAuth() {
            document.getElementById('auth-section').classList.add('active');
            document.getElementById('app-section').classList.remove('active');
            
            // Clear forms
            document.querySelectorAll('input').forEach(input => input.value = '');
        }

        function showApp() {
            document.getElementById('auth-section').classList.remove('active');
            document.getElementById('app-section').classList.add('active');
            
            // Update user info
            document.getElementById('user-name').textContent = `Welcome, ${currentUser.name}!`;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            loadTodos();
        }

        function addTodo() {
            const todoText = document.getElementById('new-todo').value.trim();
            const priority = document.getElementById('todo-priority').value;
            
            if (!todoText) {
                showNotification('Please enter a task', 'error');
                return;
            }
            
            const newTodo = {
                id: Date.now().toString(),
                text: todoText,
                completed: false,
                priority: priority,
                createdAt: new Date().toISOString()
            };
            
                         currentUser.todos.push(newTodo);
             saveUserData();
             
             // Track with Braze
             braze.logCustomEvent('Todo Added', {
                 'priority': priority,
                 'todo_count': currentUser.todos.length,
                 'user_name': currentUser.name
             });
             
             document.getElementById('new-todo').value = '';
             document.getElementById('todo-priority').value = 'medium';
             
             loadTodos();
             showNotification('Task added successfully!', 'success');
        }

        function toggleTodo(id) {
                         const todo = currentUser.todos.find(t => t.id === id);
             if (todo) {
                 todo.completed = !todo.completed;
                 saveUserData();
                 
                 // Track with Braze
                 braze.logCustomEvent('Todo Toggled', {
                     'completed': todo.completed,
                     'priority': todo.priority,
                     'user_name': currentUser.name
                 });
                 
                 loadTodos();
                 
                 const message = todo.completed ? 'Task completed!' : 'Task marked as pending';
                 showNotification(message, 'success');
             }
        }

                 function deleteTodo(id) {
             if (confirm('Are you sure you want to delete this task?')) {
                 const todoToDelete = currentUser.todos.find(t => t.id === id);
                 currentUser.todos = currentUser.todos.filter(t => t.id !== id);
                 saveUserData();
                 
                 // Track with Braze
                 braze.logCustomEvent('Todo Deleted', {
                     'priority': todoToDelete ? todoToDelete.priority : 'unknown',
                     'was_completed': todoToDelete ? todoToDelete.completed : false,
                     'user_name': currentUser.name
                 });
                 
                 loadTodos();
                 showNotification('Task deleted', 'success');
             }
         }

                 function editTodo(id) {
             const todo = currentUser.todos.find(t => t.id === id);
             if (todo) {
                 const newText = prompt('Edit task:', todo.text);
                 if (newText && newText.trim()) {
                     const oldText = todo.text;
                     todo.text = newText.trim();
                     saveUserData();
                     
                     // Track with Braze
                     braze.logCustomEvent('Todo Edited', {
                         'priority': todo.priority,
                         'text_changed': oldText !== newText.trim(),
                         'user_name': currentUser.name
                     });
                     
                     loadTodos();
                     showNotification('Task updated!', 'success');
                 }
             }
         }

                 function filterTodos(filter) {
             currentFilter = filter;
             
             // Track with Braze
             braze.logCustomEvent('Filter Applied', {
                 'filter_type': filter,
                 'user_name': currentUser.name
             });
             
             // Update filter buttons
             document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
             event.target.classList.add('active');
             
             loadTodos();
         }

        function loadTodos() {
            const todoList = document.getElementById('todo-list');
            let todos = currentUser.todos || [];
            
            // Apply filter
            switch (currentFilter) {
                case 'pending':
                    todos = todos.filter(t => !t.completed);
                    break;
                case 'completed':
                    todos = todos.filter(t => t.completed);
                    break;
                case 'high':
                    todos = todos.filter(t => t.priority === 'high');
                    break;
            }
            
            // Sort by priority and creation date
            todos.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                }
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            if (todos.length === 0) {
                todoList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>No tasks found</h3>
                        <p>${currentFilter === 'all' ? 'Add your first task above to get started!' : `No ${currentFilter} tasks found.`}</p>
                    </div>
                `;
            } else {
                todoList.innerHTML = todos.map(todo => `
                    <div class="todo-item ${todo.completed ? 'completed' : ''} priority-${todo.priority} fade-in">
                        <div class="todo-checkbox ${todo.completed ? 'checked' : ''}" onclick="toggleTodo('${todo.id}')">
                            ${todo.completed ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                        <div class="todo-text">${escapeHtml(todo.text)}</div>
                        <div class="todo-actions">
                            <button class="action-btn edit-btn" onclick="editTodo('${todo.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteTodo('${todo.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            updateStats();
        }

        function updateStats() {
            const allTodos = currentUser.todos || [];
            const completed = allTodos.filter(t => t.completed).length;
            const pending = allTodos.length - completed;
            
            document.getElementById('total-tasks').textContent = allTodos.length;
            document.getElementById('completed-tasks').textContent = completed;
            document.getElementById('pending-tasks').textContent = pending;
        }

                 function saveUserData() {
             // Update user in localStorage
             localStorage.setItem('taskflow_user', JSON.stringify(currentUser));
             
             // Update user in users collection
             const users = JSON.parse(localStorage.getItem('taskflow_users') || '{}');
             users[currentUser.email] = currentUser;
             localStorage.setItem('taskflow_users', JSON.stringify(users));
             
             // Update Braze user profile with latest data
             updateBrazeUserProfile();
         }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                font-weight: 500;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

                 // Add some demo data for first-time users
         function addDemoData() {
             if (currentUser && currentUser.todos.length === 0) {
                 const demoTodos = [
                     { id: '1', text: 'Welcome to TaskFlow! ðŸŽ‰', completed: false, priority: 'high', createdAt: new Date().toISOString() },
                     { id: '2', text: 'Try adding your own tasks', completed: false, priority: 'medium', createdAt: new Date().toISOString() },
                     { id: '3', text: 'Click the checkbox to complete tasks', completed: true, priority: 'low', createdAt: new Date().toISOString() }
                 ];
                 
                 currentUser.todos = demoTodos;
                 saveUserData();
                 loadTodos();
             }
         }

         // Braze helper functions
         function updateBrazeUserProfile() {
             if (currentUser) {
                 const user = braze.getUser();
                 user.setFirstName(currentUser.name.split(' ')[0]);
                 user.setLastName(currentUser.name.split(' ').slice(1).join(' ') || '');
                 user.setEmail(currentUser.email);
                 user.setCustomUserAttribute('total_todos', currentUser.todos.length);
                 user.setCustomUserAttribute('completed_todos', currentUser.todos.filter(t => t.completed).length);
                 user.setCustomUserAttribute('high_priority_todos', currentUser.todos.filter(t => t.priority === 'high').length);
                 user.setCustomUserAttribute('account_created', currentUser.createdAt);
                 user.setCustomUserAttribute('last_login', new Date().toISOString());
             }
         }

         function toggleBrazeCards() {
             braze.toggleContentCards(document.getElementById("braze-feed"));
             braze.logCustomEvent('Content Cards Toggled', { 
                 'user_name': currentUser ? currentUser.name : 'anonymous' 
             });
         }

         function hideBrazeCards() {
             braze.hideContentCards();
             braze.logCustomEvent('Content Cards Hidden', { 
                 'user_name': currentUser ? currentUser.name : 'anonymous' 
             });
         }

         function showBrazeCards() {
             braze.showContentCards(document.getElementById("braze-feed"));
             braze.logCustomEvent('Content Cards Shown', { 
                 'user_name': currentUser ? currentUser.name : 'anonymous' 
             });
         }
    </script>
</body>
</html>
